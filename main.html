<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falling Items ‚Äî Game</title>

   <style>
    :root{
      /* –¶–≤–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (HUD/–∫–Ω–æ–ø–∫–∏/–∞–∫—Ü–µ–Ω—Ç—ã) –ø–æ–¥—Å—Ç–∞–≤–∏–º –∏–∑ cfg.style.borderColor */
      --ui: #ffd700;
      --ui-soft: rgba(255,215,0,.14);

      /* –¶–≤–µ—Ç –Ω–µ–æ–Ω–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω cfg.style.glow) */
      --glow: #00f0ff;
    }

    /* –ë–ê–ó–ê */
    html,body{height:100%}
    body{
      margin:0;
      background: transparent;          /* –í–ê–ñ–ù–û: —Ñ–æ–Ω –≤—Å–µ–≥–æ —Ñ—Ä–µ–π–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
      color:#fff;
      overflow:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    /* –°—Ü–µ–Ω–∞ */
    #game{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
      /* –Ω–∏–∫–∞–∫–∏—Ö —Ñ–æ–Ω–æ–≤ ‚Äî –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –¥–æ –≥—Ä–∞–Ω–∏—Ü iframe */
    }

    /* HUD */
     /* HUD */
    .hud{
      position:fixed; left:12px; top:12px; right:12px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      font-weight:700; z-index:10; pointer-events:none;
    }
    .badge{
      pointer-events:none;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:8px 14px;
      box-shadow:0 8px 24px rgba(0,0,0,.35), 0 0 18px var(--ui-soft) inset;
      font-size:16px;
    }
    .levelTitle{ color:var(--ui); font-size:14px; }
    .timer{min-width:96px; text-align:center}
    .score{min-width:96px; text-align:center}

    .hud-center{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      text-align:center;
      max-width:60%;
      pointer-events:none;
      gap:2px;
    }

    .hudQuestion{
      font-weight:500;
      line-height:1.2;
      max-width:100%;
      white-space:normal;
      word-wrap:break-word;
      max-height:3.6em;         /* –¥–æ ~3 —Å—Ç—Ä–æ–∫ */
      overflow:hidden;
      text-overflow:ellipsis;
      transition:font-size .15s ease, opacity .15s ease;
    }


    /* –û–≤–µ—Ä–ª–µ–∏ (—Å—Ç–∞—Ä—Ç/–º–µ–∂—É—Ä–æ–≤–Ω–µ–≤—ã–π/—Ñ–∏–Ω–∞–ª) */
    .overlay{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center; flex-direction:column;
      background: none;                /* –ù–∏–∫–∞–∫–∏—Ö –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–π ‚Äî —Ñ—Ä–µ–π–º –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
      color:#fff; z-index:20; gap:18px;
      pointer-events:auto;
    }
    .overlay .panel{
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.12);
      border-radius:16px;
      padding:22px 26px;
      text-align:center;
      box-shadow:0 0 26px var(--ui-soft);
      min-width:min(92vw,560px);
    }
    .overlay h2{
      margin:6px 0 6px;
      font-size:24px; font-weight:900; color:var(--ui);
      text-shadow:0 0 20px var(--ui-soft);
    }
    .overlay p{ margin:0 0 8px; opacity:.9 }
    .overlay .row{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap }
    .overlay button{
      background:linear-gradient(90deg,#ffbf00,#ffd700);
      color:#000; border:0; border-radius:10px; font-weight:900; padding:12px 16px; cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .overlay button:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(255,215,0,.35) }

    /* –ü–∞–¥–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
    .item{
      position:absolute;
      top:-160px; left:0;
      transform:translateZ(0);
      will-change:transform, top, left, width, height;
      display:inline-flex;
      align-items:center; justify-content:center;
      min-width:120px; min-height:80px;
      padding:0;                          /* –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã ‚Äî –≤ .content */
      user-select:none; cursor:pointer;
    }
    .item .bg{
      position:absolute; inset:0;
      background: transparent;            /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–ª–æ–π */
      opacity:1;
      border:0 solid #fff;                /* –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∏–∑ cfg.style */
      box-shadow:none;                    /* –≠—Ñ—Ñ–µ–∫—Ç—ã —Å—é–¥–∞ */
      transition:filter .15s ease;
      background-position:center !important;
      background-repeat:no-repeat !important;
      background-size: contain !important;/* –ö–∞—Ä—Ç–∏–Ω–∫–∞-—Ä–∞–º–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –±–æ–∫—Å */
    }
  .item .content{
  position:relative; z-index:1;
  display:flex; align-items:center; justify-content:center;
  text-align:center; line-height:1.15;
  /* —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∑–∞–¥–∞—ë–º —á–µ—Ä–µ–∑ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
  width: var(--cw, auto);
  height: var(--ch, auto);
}
    .item .content span{
      display:inline-block;
      font-weight:800;
      white-space:nowrap;
    }
    /* MathJax –¥–æ–ª–∂–µ–Ω –Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ä –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.item .content .mjx-container{ font-size: inherit !important; }
   .item .content img{
  display:block;
  width:100%;          /* –≤–∞–∂–Ω–æ: –∫–∞—Ä—Ç–∏–Ω–∫–∞ –∑–∞–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç-–±–æ–∫—Å */
  height:100%;
  max-width:none;      /* –Ω–∏–∫–∞–∫–∏—Ö ¬´—Ä–∞–Ω–¥–æ–º–Ω—ã—Ö¬ª 180x140 */
  max-height:none;
  object-fit:contain;  /* –≤–ø–∏—Å–∞—Ç—å –≤–Ω—É—Ç—Ä—å –±–æ–∫—Å–∞ */
  pointer-events:none;
}
    /* –§–∏–≥—É—Ä—ã ‚Äî –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫ .bg (—Ñ–æ–Ω-—Å–ª–æ–π), –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –∫–ª–∏–ø–∞–µ—Ç—Å—è */
    .shape-rect    .bg{ border-radius:10px }
    .shape-rounded .bg{ border-radius:20px }
    .shape-circle  .bg{ border-radius:50% }
    .shape-diamond .bg{ clip-path:polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%) }
    .shape-star    .bg{
      clip-path: polygon(
        50% 0%, 61% 35%, 98% 35%,
        68% 57%, 79% 91%, 50% 70%,
        21% 91%, 32% 57%, 2% 35%, 39% 35%
      );
    }
/* ---------- –†–æ–º–±/–∑–≤–µ–∑–¥–∞: —Ä–∞–º–∫–∞ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã —á–µ—Ä–µ–∑ drop-shadow ---------- */

/* –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è ¬´—Ä–∞–º–∫–∞¬ª –¥–ª—è –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ (—Ç–æ–ª—â–∏–Ω–∞/—Ü–≤–µ—Ç –ø—Ä–∏–¥—É—Ç –∏–∑ JS –∫–∞–∫ CSS-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ) */
.poly-border { box-shadow: inset 0 0 0 var(--bw, 1px) var(--bc, #fff); }

/* –¢–µ–Ω—å */
.shape-diamond.fx-shadow .bg,
.shape-star.fx-shadow .bg{
  filter: drop-shadow(0 10px 18px rgba(0,0,0,.55));
  box-shadow: none; /* –æ—Ç–∫–ª—é—á–∞–µ–º –æ–±—ã—á–Ω—ã–µ —Ç–µ–Ω–∏, –∏–Ω–∞—á–µ –∏—Ö –≤—Å—ë —Ä–∞–≤–Ω–æ ¬´—Å—ä–µ—Å—Ç¬ª clip-path */
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ (glow) */
.shape-diamond.fx-glow .bg,
.shape-star.fx-glow .bg{
  filter: drop-shadow(0 0 12px var(--glow, #00f0ff));
}

/* 3D (—Å–¥–µ–ª–∞–µ–º –∫–∞–∫ —á—É—Ç—å —Å–º–µ—â—ë–Ω–Ω—É—é —Ç–µ–Ω—å) */
.shape-diamond.fx-3d .bg,
.shape-star.fx-3d .bg{
  filter: drop-shadow(7px 7px 16px rgba(0,0,0,.55));
}

    /* –≠—Ñ—Ñ–µ–∫—Ç—ã */
    .fx-shadow .bg{ box-shadow:0 10px 30px rgba(0,0,0,.55) }
    .fx-3d     .bg{ box-shadow: 7px 7px 20px rgba(0,0,0,.55), inset -5px -5px 12px rgba(255,255,255,.22) }
    .fx-glow   .bg{ box-shadow:0 0 18px var(--glow, #00f0ff), 0 0 28px rgba(0,0,0,.25) }
    .fx-border .bg{ border-style:solid }

    /* –ü–æ–ø –ø—Ä–∏ –ª–æ–≤–ª–µ */
    .caught{ animation:pop .45s ease forwards }
    @keyframes pop{
      0%{ transform:scale(1); opacity:1 }
      50%{ transform:scale(1.14); opacity:1 }
      100%{ transform:scale(0.85); opacity:0 }
    }

    /* –ë–ª—ë—Å—Ç–∫–∏ */
    .sparkle{
      position:absolute; width:6px; height:6px; border-radius:50%;
      background:rgba(255,255,255,.9); pointer-events:none;
      animation:spark 0.9s forwards;
      filter:drop-shadow(0 0 6px #fff); z-index:5;
    }
    @keyframes spark{
      from{ opacity:1; transform:translate(0,0) scale(1) }
      to  { opacity:0; transform:translate(var(--dx), var(--dy)) scale(.2) }
    }

    /* –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ—á–∫–∏ */
    .score-float{
      position:fixed; z-index:30;
      font-weight:900;
      text-shadow: 0 0 10px rgba(255,255,255,.5), 0 0 20px var(--ui-soft);
      animation:floatUp .85s ease-out forwards;
      pointer-events:none;
    }
    @keyframes floatUp{
      0%  { transform:translate(-50%,-10px); opacity:0 }
      10% { opacity:1; }
      100%{ transform:translate(-50%,-60px); opacity:0 }
    }

    /* –§–µ–π–µ—Ä–≤–µ—Ä–∫ (—Ñ–∏–Ω–∞–ª/–º–µ–∂—É—Ä–æ–≤–Ω–µ–≤—ã–π) */
    .firework{
      position:fixed; width:4px; height:4px; border-radius:50%;
      background:#fff; pointer-events:none; z-index:40; animation:fw 900ms ease-out forwards;
    }
    @keyframes fw{
      from{ transform:translate(0,0) scale(1); opacity:1 }
      to  { transform:translate(var(--tx), var(--ty)) scale(0.1); opacity:0 }
    }
    /* üî¥ –∫—Ä–∞—Å–Ω–∞—è –≤—Å–ø—ã—à–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ */
/* ‚úÖ –∫—Ä–∞—Å–Ω—ã–π —Ç–∏–Ω—Ç –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞ (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ —Å bgImage, –∏ —Å bgColor) */
/* ‚úÖ –∫—Ä–∞—Å–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä, –Ω–µ –∑–∞–ª–∏–≤–∞–µ—Ç –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —É—á–∞—Å—Ç–∫–∏ */
.tint-red .bg {
  animation: redTintOnly 550ms ease;
}

@keyframes redTintOnly {
  0%   { filter: none; }
  15%  { filter: hue-rotate(-25deg) saturate(3) brightness(1.2) contrast(1.2); }
  50%  { filter: hue-rotate(-10deg) saturate(2.5) brightness(1.1) contrast(1.1); }
  100% { filter: none; }
}
         /* ===== –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–∞–¥—É–∂–Ω–æ–π –Ω–µ–æ–Ω–æ–≤–æ–π —Ä–∞–º–∫–æ–π ===== */
    .final-card{
      position:relative;
      padding:4px;
      border-radius:20px;
      overflow:hidden;
      animation:finalFadeIn .45s ease-out both;
    }
    .final-glow{
      position:absolute;
      inset:0;
      background:conic-gradient(
        from 0deg,
        #ff4d6a,#ffb347,#ffe65b,
        #6bff8a,#5bdcff,#a56bff,#ff4dff,#ff4d6a
      );
      animation:glowSpin 5s linear infinite;
      opacity:.9;
    }
    .final-inner{
      position:relative;
      border-radius:16px;
      background:rgba(10,10,25,.96);
      padding:22px 26px;
      min-width:min(92vw,360px);
      color:#fff;
      text-align:center;
    }
    .final-title{
      font-size:26px;
      margin:0 0 10px;
      color:var(--ui);
      text-shadow:0 0 18px var(--ui-soft);
    }
    .final-main-score{
      font-size:32px;
      font-weight:800;
      margin-bottom:12px;
      text-shadow:0 0 18px rgba(255,255,255,.5);
    }
    .final-stats{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:6px 14px;
      text-align:left;
      font-size:15px;
      margin-bottom:18px;
    }
    .final-stats .label{opacity:.85}
    .final-stats .value{font-weight:700}
    .btn-final{
      background:linear-gradient(90deg,#ffbf00,#ffd700);
      color:#000;
      border:0;
      border-radius:999px;
      font-weight:900;
      padding:10px 20px;
      cursor:pointer;
      font-size:16px;
      box-shadow:0 8px 26px rgba(0,0,0,.45);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .btn-final:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 30px rgba(0,0,0,.6);
    }
    @keyframes glowSpin{
      from{ transform:rotate(0deg); }
      to  { transform:rotate(360deg); }
    }
    @keyframes finalFadeIn{
      from{ opacity:0; transform:translateY(10px) scale(.96);}
      to  { opacity:1; transform:translateY(0) scale(1);}
    }

  </style>
    <script>
    // === –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Google Fonts –∏–∑ cfg.font ===
    function loadGoogleFont(fontName){
      if(!fontName) return;
      const family = fontName.replace(/ /g, '+');
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = `https://fonts.googleapis.com/css2?family=${family}:wght@400;700&display=swap`;
      document.head.appendChild(link);
    }
  </script>
</head>
<body>

  <!-- HUD -->
  <!-- HUD -->
  <div class="hud">
    <div class="badge timer" id="hudTimer">00:00</div>

    <div class="hud-center">
      <div class="badge levelTitle" id="hudLevel">–í–æ–ø—Ä–æ—Å 1 / 1</div>
      <div class="hudQuestion" id="hudQuestion"></div>
    </div>

    <div class="badge score" id="hudScore">0</div>
  </div>

  <!-- –°—Ü–µ–Ω–∞ -->
  <div id="game" aria-live="polite"></div>

   <!-- MathJax –¥–ª—è —Ñ–æ—Ä–º—É–ª -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <script>
    /* ===================== –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è ===================== */
   const I18N = {
  ru:{
    startTitle:"–ò–≥—Ä–∞ ¬´–ü–∞–¥–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã¬ª",
    startBtn:"–ù–∞—á–∞—Ç—å", contBtn:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", nextBtn:"–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å",
    restartBtn:"–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞", 
    catchAll:"–ü–æ–π–º–∞–π –≤—Å–µ",
    level:n=>`–£—Ä–æ–≤–µ–Ω—å ${n}`, levelOf:(n,t)=>`–£—Ä–æ–≤–µ–Ω—å ${n} –∏–∑ ${t}`,
    time:"–í—Ä–µ–º—è", score:"–°—á—ë—Ç",
    levelComplete:"–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!", gameComplete:"–ò–≥—Ä–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!",
    hits:"–ü–æ–ø–∞–¥–∞–Ω–∏–π", wrong:"–ú–∏–º–æ", missed:"–£—à–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö", total:"–ò—Ç–æ–≥–æ",
    finalFeedbackTitle:"–ú–æ–ª–æ–¥–µ—Ü!", defaultFinalFeedback:"–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!"
  },
  en:{
    startTitle:"Falling Items",
    startBtn:"Start", contBtn:"Continue", nextBtn:"Next level",
    restartBtn:"Play again",
    catchAll:"Catch all",
    level:n=>`Level ${n}`, levelOf:(n,t)=>`Level ${n} of ${t}`,
    time:"Time", score:"Score",
    levelComplete:"Level complete!", gameComplete:"Game complete!",
    hits:"Hits", wrong:"Wrong clicks", missed:"Missed correct", total:"Total",
    finalFeedbackTitle:"Well done!", defaultFinalFeedback:"Great job!"
  },
  fr:{
    startTitle:"Objets Tombants",
    startBtn:"Commencer", contBtn:"Continuer", nextBtn:"Niveau suivant",
    restartBtn:"Rejouer",
    catchAll:"Attrapez tous",
    level:n=>`Niveau ${n}`, levelOf:(n,t)=>`Niveau ${n} sur ${t}`,
    time:"Temps", score:"Score",
    levelComplete:"Niveau termin√© !", gameComplete:"Jeu termin√© !",
    hits:"Touch√©s", wrong:"Faux clics", missed:"Justes rat√©s", total:"Total",
    finalFeedbackTitle:"Bravo !", defaultFinalFeedback:"Excellent travail !"
  },
  es:{
    startTitle:"Elementos Cayendo",
    startBtn:"Comenzar", contBtn:"Continuar", nextBtn:"Siguiente nivel",
    restartBtn:"Jugar de nuevo",
    catchAll:"Atrapa todos",
    level:n=>`Nivel ${n}`, levelOf:(n,t)=>`Nivel ${n} de ${t}`,
    time:"Tiempo", score:"Puntuaci√≥n",
    levelComplete:"¬°Nivel completado!", gameComplete:"¬°Juego completado!",
    hits:"Aciertos", wrong:"Clics err√≥neos", missed:"Correctos perdidos", total:"Total",
    finalFeedbackTitle:"¬°Bien hecho!", defaultFinalFeedback:"¬°Gran trabajo!"
  },
  de:{
    startTitle:"Fallende Elemente",
    startBtn:"Start", contBtn:"Weiter", nextBtn:"N√§chste Stufe",
    restartBtn:"Nochmals spielen",
    catchAll:"Fange alle",
    level:n=>`Level ${n}`, levelOf:(n,t)=>`Level ${n} von ${t}`,
    time:"Zeit", score:"Punkte",
    levelComplete:"Level geschafft!", gameComplete:"Spiel beendet!",
    hits:"Treffer", wrong:"Falsche Klicks", missed:"Verpasste Richtige", total:"Gesamt",
    finalFeedbackTitle:"Gut gemacht!", defaultFinalFeedback:"Weiter so!"
  },
  zh:{
    startTitle:"‰∏ãËêΩÂÖÉÁ¥†",
    startBtn:"ÂºÄÂßã", contBtn:"ÁªßÁª≠", nextBtn:"‰∏ã‰∏ÄÂÖ≥",
    restartBtn:"ÂÜçÁé©‰∏ÄÊ¨°",
    catchAll:"Êäì‰ΩèÊâÄÊúâ",
    level:n=>`Á¨¨ ${n} ÂÖ≥`, levelOf:(n,t)=>`Á¨¨ ${n}/${t} ÂÖ≥`,
    time:"Êó∂Èó¥", score:"ÂàÜÊï∞",
    levelComplete:"ÂÖ≥Âç°ÈÄöËøáÔºÅ", gameComplete:"Ê∏∏ÊàèÂÆåÊàêÔºÅ",
    hits:"ÂëΩ‰∏≠", wrong:"ËØØÁÇπ", missed:"ÈîôËøáÊ≠£Á°Æ", total:"ÊÄªÂàÜ",
    finalFeedbackTitle:"ÂÅöÂæóÂ•ΩÔºÅ", defaultFinalFeedback:"ÁªßÁª≠Âä™ÂäõÔºÅ"
  },
  ja:{
    startTitle:"ËêΩ‰∏ã„Ç¢„Ç§„ÉÜ„É†",
    startBtn:"„Çπ„Çø„Éº„Éà", contBtn:"„Å§„Å•„Åë„Çã", nextBtn:"Ê¨°„ÅÆ„É¨„Éô„É´",
    restartBtn:"„ÇÇ„ÅÜ‰∏ÄÂ∫¶",
    catchAll:"ÂÖ®ÈÉ®„Ç≠„É£„ÉÉ„ÉÅ",
    level:n=>`„É¨„Éô„É´ ${n}`, levelOf:(n,t)=>`${t} ‰∏≠ ${n} „É¨„Éô„É´`,
    time:"ÊôÇÈñì", score:"„Çπ„Ç≥„Ç¢",
    levelComplete:"„É¨„Éô„É´„ÇØ„É™„Ç¢ÔºÅ", gameComplete:"„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ",
    hits:"„Éí„ÉÉ„Éà", wrong:"„Éü„Çπ„ÇØ„É™„ÉÉ„ÇØ", missed:"Ë¶ãÈÄÉ„Åó„ÅüÊ≠£Ëß£", total:"ÂêàË®à",
    finalFeedbackTitle:"„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ", defaultFinalFeedback:"„Åù„ÅÆË™øÂ≠êÔºÅ"
  },
 math:{
  startTitle:"–ò–≥—Ä–∞ ¬´–ü–∞–¥–∞—é—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã¬ª (–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞)",
  startBtn:"–ù–∞—á–∞—Ç—å", contBtn:"–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å", nextBtn:"–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å",
  restartBtn:"–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞",
  catchAll:"–ü–æ–π–º–∞–π –≤—Å–µ",
  level:n=>`–£—Ä–æ–≤–µ–Ω—å ${n}`, levelOf:(n,t)=>`–£—Ä–æ–≤–µ–Ω—å ${n} –∏–∑ ${t}`,
  time:"–í—Ä–µ–º—è", score:"–°—á—ë—Ç",
  levelComplete:"–£—Ä–æ–≤–µ–Ω—å –ø—Ä–æ–π–¥–µ–Ω!", gameComplete:"–ò–≥—Ä–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!",
  hits:"–ü–æ–ø–∞–¥–∞–Ω–∏–π", wrong:"–ú–∏–º–æ", missed:"–£—à–ª–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö", total:"–ò—Ç–æ–≥–æ",
  finalFeedbackTitle:"–ú–æ–ª–æ–¥–µ—Ü!", defaultFinalFeedback:"–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!"
}
};
    function t(lang,key,...args){
      const dict = I18N[lang]||I18N.ru; const v = dict[key];
      return (typeof v==="function")?v(...args):(v??key);
    }
function parseBgList(v){
  if(!v) return [];
  if(Array.isArray(v)) return v.filter(Boolean);
  return String(v).split(/[\n\r,|;]+/).map(s=>s.trim()).filter(Boolean);
}
    /* ===================== –£—Ç–∏–ª–∏—Ç—ã ===================== */
    const $ = sel => document.querySelector(sel);
    const rnd = (a,b)=> a + Math.random()*(b-a);
    const clamp = (v,min,max)=> Math.max(min, Math.min(max,v));

    function hexToRgb(hex){
      let s = (hex||'').trim();
      if(!s) return {r:255,g:215,b:0};
      if(s[0]==='#') s=s.slice(1);
      if(s.length===3) s=s.split('').map(c=>c+c).join('');
      const n=parseInt(s,16);
      return {r:(n>>16)&255, g:(n>>8)&255, b:(n)&255};
    }

    /* ===================== –ó–∞–≥—Ä—É–∑–∫–∞ cfg –ø–æ id ===================== */
    const params = new URLSearchParams(location.search);
    const GAME_ID = params.get('id');                           // —Å—Ç–∞—Ä–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
    const JSON_BASE = "https://nikashum93.github.io/texts/data/"; // –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ

    let cfg = null;
    let LANG = 'ru'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

(async function boot(){
  if(!GAME_ID){
    showFatal("No id", "–ù–µ –ø–µ—Ä–µ–¥–∞–Ω id –≤ —Å—Ç—Ä–æ–∫–µ –∑–∞–ø—Ä–æ—Å–∞.");
    return;
  }
  try{
    const url = `${JSON_BASE}${encodeURIComponent(GAME_ID)}.json?v=${Date.now()}`;
    const res = await fetch(url, { cache:'no-store' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    cfg = await res.json();
  }catch(e){
    showFatal("Load error", `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫: ${e.message}\n–ü—Ä–æ–≤–µ—Ä—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é –≤ texts/data.`);
    return;
  }

  // –Ø–ó–´–ö ‚Äî —Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ, cfg —É–∂–µ –µ—Å—Ç—å
  LANG = (cfg.language || 'ru').toLowerCase();

  // –®–†–ò–§–¢
  if(cfg.font){
    loadGoogleFont(cfg.font);
  }

  // –¶–≤–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  const uiColor = (cfg.style && (cfg.style.borderColor || cfg.style.glowColor)) || '#ffd700';
  document.documentElement.style.setProperty('--ui', uiColor);
  document.documentElement.style.setProperty('--ui-soft', 'rgba('+Object.values(hexToRgb(uiColor)).join(',') + ',.14)');

  if (cfg.style && cfg.style.glowColor){
    document.documentElement.style.setProperty('--glow', cfg.style.glowColor);
  }

  // –ö–∞—Å—Ç–æ–º–Ω—ã–π –∫—É—Ä—Å–æ—Ä
  if (cfg.cursor) document.body.style.cursor = `url(${cfg.cursor}), auto`;

  // –§–û–ù–´ (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ, –≤–∫–ª—é—á–∞—è GIF)
  setupBackgrounds();

  // HUD + —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –º–µ–Ω—é –¥–æ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã
  updateHUD(1, (cfg.levels||[]).length||0);
  showStartOverlay();
})();

// === üî¥ –§–æ–Ω—ã —Å—Ü–µ–Ω—ã: –≤—ã–±–æ—Ä —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ GIF ===
let bgImgEl = null;
function setupBackgrounds(){
  const list = Array.isArray(cfg.backgrounds) ? cfg.backgrounds.filter(Boolean) : [];
  if (!list.length){
    if (bgImgEl){ bgImgEl.remove(); bgImgEl = null; }
    return;
  }

  if (!bgImgEl){
    bgImgEl = document.createElement('img');
    Object.assign(bgImgEl.style, {
      position:'fixed', inset:'0', width:'100%', height:'100%',
      objectFit:'cover', zIndex:'-1', pointerEvents:'none'
    });
    document.body.prepend(bgImgEl);
  }

  // —Å–ª—É—á–∞–π–Ω—ã–π –≤—ã–±–æ—Ä —Ñ–æ–Ω–∞
  const pick = () => list[Math.floor(Math.random()*list.length)];

  // –ø–µ—Ä–≤—ã–π —Ñ–æ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  bgImgEl.src = pick();

  // –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ —É—Ä–æ–≤–Ω—è ‚Äî –Ω–æ–≤—ã–π —Ñ–æ–Ω
  const _startLevel = startLevel;
  startLevel = function(){
    if (bgImgEl && bgImgEl.parentNode){
      const fresh = bgImgEl.cloneNode(false);
      fresh.src = pick();
      bgImgEl.parentNode.replaceChild(fresh, bgImgEl);
      bgImgEl = fresh;
    }
    _startLevel();
  };
}

      /* ===================== HUD / –û–≤–µ—Ä–ª–µ–∏ ===================== */
    const hudLevel = $('#hudLevel');
    const hudTimer = $('#hudTimer');
    const hudScore = $('#hudScore');
    const hudQuestion = $('#hudQuestion');

    function updateHUD(current, total, neededCorrect){
      const lang = (cfg.language || 'ru').toLowerCase();
      const isRu = (lang === 'ru' || lang === 'math');
      const baseLabel = isRu ? '–í–æ–ø—Ä–æ—Å' : 'Question';
      let extra = '';
      if (neededCorrect && neededCorrect > 1){
        extra = isRu ? ` ¬∑ –Ω—É–∂–Ω–æ ${neededCorrect}` : ` ¬∑ need ${neededCorrect}`;
      }
      hudLevel.textContent = `${baseLabel} ${current} / ${total}${extra}`;
    }

    function setQuestionText(text){
      if (!hudQuestion) return;
      const lang = (cfg.language || 'ru').toLowerCase();
      const isMath = (lang === 'math');

      if (isMath && text){
        hudQuestion.textContent = `\\(${text}\\)`;
        MathJax.typesetPromise([hudQuestion]);
      } else {
        hudQuestion.textContent = text || '';
      }

      const len = (text || '').length;
      let size = 26;
      if (len > 110) size = 18;
      else if (len > 60) size = 22;
      hudQuestion.style.fontSize = size + 'px';
    }


    function showFatal(title, message){
      const ov = document.createElement('div');
      ov.className = 'overlay';
      ov.innerHTML = `
        <div class="panel">
          <h2>${title}</h2>
          <p style="white-space:pre-wrap">${message}</p>
        </div>`;
      document.body.appendChild(ov);
    }

    let overlayNode = null;

function showStartOverlay(){
  if (overlayNode) overlayNode.remove();
  overlayNode = document.createElement('div');
  overlayNode.className = 'overlay';

  const total = (cfg.levels||[]).length || 0;
  const targetVal = cfg.levels.length > 0 ? (cfg.levels[0].target || "") : "";
  const isMath = (cfg.language || '') === 'math';
  const targetHtml = targetVal ? (isMath ? `\\(${targetVal}\\)` : targetVal) : "";

  // ‚úÖ –ù–û–í–û–ï: –¥–∞—ë–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  const title  = (cfg.start && typeof cfg.start.title === 'string' && cfg.start.title.trim())
                 ? cfg.start.title.trim()
                 : t(LANG,'startTitle');
  const btnTxt = (cfg.start && typeof cfg.start.btnText === 'string' && cfg.start.btnText.trim())
                 ? cfg.start.btnText.trim()
                 : t(LANG,'startBtn');

  overlayNode.innerHTML = `
    <div class="panel">
      <h2>${title}</h2>
      <p>${t(LANG,'catchAll')} ${targetHtml}</p>
      <div class="row" style="margin-top:14px">
        <button id="btnStart">${btnTxt}</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlayNode);

  if (isMath && targetHtml) {
    MathJax.typesetPromise([overlayNode]);
  }

  $('#btnStart').addEventListener('click', ()=>{
    overlayNode.remove();
    startGame();
  }, { once: true });
}

   function showLevelCompleteOverlay(current, total, onNext){
  if (overlayNode) overlayNode.remove();
  overlayNode = document.createElement('div');
  overlayNode.className = 'overlay';
  overlayNode.innerHTML = `
    <div class="panel">
      <h2>${t(LANG,'levelComplete')}</h2>
      <p>${t(LANG,'levelOf', current, total)}</p>
      <div class="row"><button id="btnNext">${t(LANG,'nextBtn')}</button></div>
    </div>`;
  document.body.appendChild(overlayNode);
  $('#btnNext').addEventListener('click', ()=>{
    overlayNode.remove();
    onNext && onNext();
  }, { once:true });
}

function showGameCompleteOverlay(stats){
  if (overlayNode) overlayNode.remove();
  overlayNode = document.createElement('div');
  overlayNode.className = 'overlay';

  const custom  = (cfg.finalFeedback || cfg.feedback || "").trim();
  const fbTitle = t(LANG,'finalFeedbackTitle');
  const fbText  = t(LANG,'defaultFinalFeedback');

  const sc = (stats && stats.score != null) ? stats.score : score;
  const h  = stats?.hits ?? hits;
  const w  = stats?.wrong ?? wrongClicks;
  const m  = stats?.missed ?? missedCorrect;

  overlayNode.innerHTML = `
    <div class="final-card">
      <div class="final-glow"></div>
      <div class="final-inner">
        <h2 class="final-title">${t(LANG,'gameComplete')}</h2>
        ${
          custom
            ? `<p style="white-space:pre-wrap; margin:0 0 10px">${custom}</p>`
            : `<p style="margin:6px 0 10px; font-size:18px; color:var(--ui)">${fbTitle}</p>
               <p style="white-space:pre-wrap; margin:0 0 4px">${fbText}</p>`
        }
        <div class="final-main-score">${sc}</div>
        <div class="final-stats">
          <div><span class="label">${t(LANG,'hits')}:</span> <span class="value" id="finalHits">${h}</span></div>
          <div><span class="label">${t(LANG,'wrong')}:</span> <span class="value" id="finalWrong">${w}</span></div>
          <div><span class="label">${t(LANG,'missed')}:</span> <span class="value" id="finalMissed">${m}</span></div>
        </div>
        <button id="btnRestart" class="btn-final">${t(LANG,'restartBtn')}</button>
      </div>
    </div>`;
  document.body.appendChild(overlayNode);
  $('#btnRestart').addEventListener('click', ()=> location.reload(), { once:true });
}



     /* ===================== –ì–µ–π–º–ø–ª–µ–π ===================== */
   const popSound   = new Audio("https://nikashum93.github.io/falling/sounds/pop.mp3");
const wrongSound = new Audio("https://nikashum93.github.io/falling/sounds/wrong.mp3");
const winSound   = new Audio("https://nikashum93.github.io/falling/sounds/win.mp3");

    let score = 0;
    let currentLevel = 0;        // –Ω–æ–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞
    let running = false;

    // –æ–±—â–∏–π —Ç–∞–π–º–µ—Ä –∫–≤–∏–∑–∞
    let globalTimerHandle = null;
    let globalTimeLeft = 0;

    // —Å–ø–∞–≤–Ω
    let spawnerHandle = null;

    // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    let hits = 0;
    let wrongClicks = 0;     // ¬´–º–∏–º–æ¬ª ‚Äî –ø–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º
    let missedCorrect = 0;   // —É–ø–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ —É—à—ë–ª –≤–Ω–∏–∑
    let streak = 0;

    // —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
    let currentQuestion = null;
    let neededCorrect = 0;
    let foundCorrect = new Set();


    function computeSpeedParams(S){
      const s = clamp(Number(S||5), 1, 10);
      // –°–∫–æ—Ä–æ—Å—Ç—å –ø–∞–¥–µ–Ω–∏—è: –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ –Ω–∞ 1, –±—ã—Å—Ç—Ä–æ –Ω–∞ 10
      const vel = 0.65 + (s-1) * (6.2-0.65)/9;   // ~0.65..6.2 px/–∫–∞–¥—Ä
      // –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–ø–∞–≤–Ω–∞: 1 ‚Äî —Ä–µ–¥–∫–∏–π —Å–ø–∞–≤–Ω, 10 ‚Äî —á–∞—Å—Ç—ã–π
      const spawn = 1700 - (s-1) * (1350)/9;     // ~1700ms ‚Üí ~350ms
      // –ë–∞–∑–∞ –æ—á–∫–æ–≤: —Å–∫–æ—Ä–æ—Å—Ç—å –≤–ª–∏—è–µ—Ç –Ω–∞ ¬´—Ü–µ–Ω—É¬ª –æ–¥–Ω–æ–≥–æ –ø–æ–ø–∞–¥–∞–Ω–∏—è
      const basePts = 8 + (s-1) * (50-8)/9;      // ~8..50
      return { vel, spawn, basePts: Math.round(basePts) };
    }
// –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ—Ç –∫–æ–ø–∏—é –º–∞—Å—Å–∏–≤–∞
function shuffleCopy(arr){
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ cfg
    let SPEED = { vel: 1.5, spawn: 1000, basePts: 20 };

    function startGame(){
      // —Å–∫–æ—Ä–æ—Å—Ç—å
      SPEED = computeSpeedParams(cfg?.speed ?? 5);

      // —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      score = 0;
      hits = 0;
      wrongClicks = 0;
      missedCorrect = 0;
      streak = 0;
      hudScore.textContent = '0';

      // –æ–±—â–∏–π —Ç–∞–π–º–µ—Ä
      if (globalTimerHandle){
        clearInterval(globalTimerHandle);
        globalTimerHandle = null;
      }
      globalTimeLeft = Number(cfg?.globalTimer || 0);

      if (globalTimeLeft > 0){
        hudTimer.textContent = formatTime(globalTimeLeft);
        globalTimerHandle = setInterval(()=>{
          if (!running) return;
          globalTimeLeft--;
          hudTimer.textContent = formatTime(globalTimeLeft);
          if (globalTimeLeft <= 0){
            clearInterval(globalTimerHandle);
            globalTimerHandle = null;
            running = false;
            stopSpawning();
            clearItems();
            fireworks();
            try{ winSound.currentTime=0; winSound.play(); }catch(_){}
            showGameCompleteOverlay({
              score,
              hits,
              wrong: wrongClicks,
              missed: missedCorrect
            });
          }
        }, 1000);
      } else {
        hudTimer.textContent = '‚àû';
      }

      // —Å–ª—É—á–∞–π–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏
      if (cfg.randomLevels && Array.isArray(cfg.levels)) {
        cfg.levels = shuffleCopy(cfg.levels);
      }

      currentLevel = 0;
      running = true;
      startLevel();
    }

    function formatTime(sec){
      const m = Math.floor(sec / 60).toString().padStart(2,'0');
      const s = (sec % 60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    function stopSpawning(){
      if (spawnerHandle){
        clearTimeout(spawnerHandle);
        spawnerHandle = null;
      }
    }

    function clearItems(){
      document.querySelectorAll('.item').forEach(n => n.remove());
    }


  function startLevel(){
    const levels = Array.isArray(cfg.levels) ? cfg.levels : [];
    currentLevel++;

    if (currentLevel > levels.length){
      running = false;
      stopSpawning();
      clearItems();
      fireworks();
      try{ winSound.currentTime=0; winSound.play(); }catch(_){}
      showGameCompleteOverlay({
        score,
        hits,
        wrong: wrongClicks,
        missed: missedCorrect
      });
      return;
    }

    currentQuestion = levels[currentLevel - 1] || {};
    const correctArr = Array.isArray(currentQuestion.correct)
      ? currentQuestion.correct.filter(Boolean)
      : [];
    neededCorrect = correctArr.length;
    foundCorrect = new Set();

    updateHUD(currentLevel, levels.length, neededCorrect);
    setQuestionText(currentQuestion.target || '');

    stopSpawning();
    clearItems();

    // ==== –°–ü–ê–£–ù –ë–ï–ó –¢–ê–ô–ú–ï–†–ê –£–†–û–í–ù–Ø ====
    const correct = correctArr.map(v => ({ val: v, good: true }));
    const wrong   = (currentQuestion.wrong || []).map(v => ({ val: v, good: false }));
    const pool = [...correct, ...wrong];
    if (!pool.length) return;

    const gh  = game.clientHeight;
    const fps = 60;
    const fallDistPx  = gh + 320;
    const fallTimeSec = fallDistPx / (SPEED.vel * fps);
    const sNorm = clamp((Number(cfg?.speed ?? 5) - 1) / 9, 0, 1);
    const targetActive = Math.round(3 + sNorm * (10 - 3));
    const maxActive    = targetActive + 1;
    let interval = (fallTimeSec / targetActive) * 1000;
    interval = clamp(interval, 300, 2200);

    function spawnNext(){
      if (!running) return;
      const activeNow = document.querySelectorAll('.item').length;
      if (activeNow >= maxActive){
        spawnerHandle = setTimeout(spawnNext, 120);
        return;
      }
      const obj = pool[Math.floor(Math.random() * pool.length)];
      drop(obj);
      const jitter = interval * (0.9 + Math.random() * 0.2);
      spawnerHandle = setTimeout(spawnNext, Math.max(120, jitter));
    }

    spawnNext();
  }

    /* ===================== –≠–ª–µ–º–µ–Ω—Ç: —Å–æ–∑–¥–∞–Ω–∏–µ/–ø–∞–¥–µ–Ω–∏–µ/–∫–ª–∏–∫ ===================== */
  function drop(obj){
  const STYLE = cfg.style || {};
  const FONT = cfg.font || 'Rubik';
  const FONT_SIZE = Number(cfg.fontSize || 24);
  const TEXT_COLOR = cfg.textColor || '#ffffff';

  const el = document.createElement('div');
  el.className = `item shape-${STYLE.shape || 'rounded'} ${STYLE.shadow?'fx-shadow':''} ${STYLE.fx3d?'fx-3d':''} ${STYLE.glow?'fx-glow':''} ${STYLE.borderOn && STYLE.borderWidth>0 ? 'fx-border' : ''}`;
  el.dataset.good = obj.good ? '1' : '0';
     el.dataset.value = obj.val;
  el.style.setProperty('--glow', STYLE.glowColor || '#00f0ff');

  // —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
  const bg = document.createElement('div');
  bg.className = 'bg';
  const content = document.createElement('div');
  content.className = 'content';

  // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞–¥–¥–∏–Ω–≥–∏ –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  const PAD = Number(STYLE.pad || 22);
  content.style.padding = PAD + 'px';
const IMG_BOX = Number(STYLE.imgBox || 160); // —Ñ–∏–∫—Å-–±–æ–∫—Å –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫ (–∫–≤–∞–¥—Ä–∞—Ç)

  el.appendChild(bg); el.appendChild(content);

   // --- –§–æ–Ω-–¥–µ—Ä–∂–∞—Ç–µ–ª—å –∑–∞–¥–∞–Ω–∏—è: –æ–¥–Ω–∞ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ä—Ç–∏–Ω–æ–∫ + –∑–∞–ø–∞—Å–Ω–æ–π —Ü–≤–µ—Ç ---
  const bgCol = STYLE.bgColor || 'transparent';

  let bgList = [];

  // 1) style.bgImage ‚Äî —Å—Ç—Ä–æ–∫–∞ —Å –æ–¥–Ω–æ–π –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Å—Å—ã–ª–∫–∞–º–∏ —á–µ—Ä–µ–∑ \n, –∑–∞–ø—è—Ç—É—é, |, ;
  if (STYLE.bgImage) {
    bgList = bgList.concat(
      String(STYLE.bgImage)
        .split(/[\n\r,|;]+/)
        .map(s => s.trim())
        .filter(Boolean)
    );
  }

  // 2) style.bgImages ‚Äî –º–∞—Å—Å–∏–≤ –ò–õ–ò —Å—Ç—Ä–æ–∫–∞, –∫–∞–∫ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
  if (STYLE.bgImages) {
    if (Array.isArray(STYLE.bgImages)) {
      bgList = bgList.concat(STYLE.bgImages.filter(Boolean));
    } else {
      bgList = bgList.concat(
        String(STYLE.bgImages)
          .split(/[\n\r,|;]+/)
          .map(s => s.trim())
          .filter(Boolean)
      );
    }
  }

  bgList = bgList.filter(Boolean);

  if (!bgList.length) {
    // –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–∏ ‚Üí –ø—Ä–æ—Å—Ç–æ —Ü–≤–µ—Ç
    bg.style.backgroundImage = 'none';
    bg.style.backgroundColor = bgCol;
  } else {
    // –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É-–¥–µ—Ä–∂–∞—Ç–µ–ª—å
    const chosenBg = bgList[Math.floor(Math.random() * bgList.length)];
    bg.style.backgroundImage = `url(${chosenBg})`;
    bg.style.backgroundColor = 'transparent';
  }

  // –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–æ–Ω-—Å–ª–æ—è
  bg.style.opacity = String(clamp(Number(STYLE.opacity ?? 1), 0, 1));

  // –†–∞–º–∫–∞ (–≥—Ä–∞–Ω–∏—Ü–∞) ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞
// –†–∞–º–∫–∞ (–≥—Ä–∞–Ω–∏—Ü–∞)
const shapeKind = (STYLE.shape || 'rounded');
if (STYLE.borderOn && STYLE.borderWidth > 0){
  const bw = `${parseInt(STYLE.borderWidth,10)}px`;
  const bc = STYLE.borderColor || '#fff';

  if (shapeKind === 'diamond' || shapeKind === 'star'){
    // –î–ª—è –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤ –¥–µ–ª–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —à—Ç—Ä–∏—Ö —á–µ—Ä–µ–∑ inset box-shadow,
    // —á—Ç–æ–±—ã clip-path –µ–≥–æ –Ω–µ ¬´—Å—ä–µ–¥–∞–ª¬ª
    bg.style.borderWidth = '0px';
    bg.classList.add('poly-border');
    bg.style.setProperty('--bw', bw);
    bg.style.setProperty('--bc', bc);
  } else {
    // –î–ª—è –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω—ã—Ö/–æ–∫—Ä—É–∂–Ω–æ—Å—Ç–µ–π –æ–±—ã—á–Ω–∞—è —Ä–∞–º–∫–∞ –æ–∫
    bg.classList.remove('poly-border');
    bg.style.removeProperty('--bw');
    bg.style.removeProperty('--bc');
    bg.style.borderColor = bc;
    bg.style.borderWidth = bw;
  }
} else {
  bg.classList.remove('poly-border');
  bg.style.removeProperty('--bw');
  bg.style.removeProperty('--bc');
  bg.style.borderWidth = '0px';
}


  // –ö–æ–Ω—Ç–µ–Ω—Ç: –∫–∞—Ä—Ç–∏–Ω–∫–∞/–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞/—Ç–µ–∫—Å—Ç
if (/^https?:\/\//i.test(obj.val)) {
  const img = document.createElement('img');
  img.src = obj.val;
  content.appendChild(img);

  // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ä–∞–±–æ—á–∞—è –æ–±–ª–∞—Å—Ç—å –ø–æ–¥ –∫–∞—Ä—Ç–∏–Ω–∫—É
  content.style.setProperty('--cw', IMG_BOX + 'px');
  content.style.setProperty('--ch', IMG_BOX + 'px');

  // —Å—Ä–∞–∑—É –∑–∞–¥–∞—ë–º –æ–±—â–∏–π –±–æ–∫—Å —ç–ª–µ–º–µ–Ω—Ç–∞ (—Ä–∞–º–∫–∞/¬´–≤–æ–∑–¥—É—Ö¬ª + –ø–∞–¥–¥–∏–Ω–≥–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
  const shape = (STYLE.shape || 'rounded');
 const hasImageFrame = (Array.isArray(STYLE.bgImage) ? STYLE.bgImage.length>0 : !!(STYLE.bgImage && String(STYLE.bgImage).trim())) || (Array.isArray(STYLE.bgImages) && STYLE.bgImages.length>0);
  const padX = hasImageFrame ? 30 : 22;
  const padY = hasImageFrame ? 24 : 18;

  let W = IMG_BOX + padX*2 + PAD*2;
  let H = IMG_BOX + padY*2 + PAD*2;

  if (shape === 'circle' || shape === 'diamond' || shape === 'star') {
    const S = Math.max(W, H);
    W = H = S;
  }

  el.style.width  = W + 'px';
  el.style.height = H + 'px';

  // –Ω–∞ —Å–ª—É—á–∞–π –ø–æ–∑–¥–Ω–µ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏
  img.onload = () => { el.style.width = W + 'px'; el.style.height = H + 'px'; };

} else if ((cfg.language||'') === 'math'){
  const span = document.createElement('span');
  span.textContent = `\\(${obj.val}\\)`;
  span.style.color = TEXT_COLOR;
  span.style.fontSize = `${FONT_SIZE}px`;                // <- —Ä–∞–∑–º–µ—Ä –∏–∑ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
  span.style.fontFamily = `${FONT}, system-ui, sans-serif`;
  content.appendChild(span);


} else {
  const span = document.createElement('span');
  span.textContent = String(obj.val);
  span.style.color = TEXT_COLOR;
  span.style.fontFamily = `${FONT}, system-ui, sans-serif`;
  span.style.fontSize = `${FONT_SIZE}px`;
  content.appendChild(span);
}


  // === –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è (–ù–û–í–û–ï)
  const DIR = (cfg.direction || 'down'); // down|up|left|right

  // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è (–ø–µ—Ä–µ–ø–∏—Å–∞–Ω–∞ –ø–æ–¥ 4 –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è; –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–µ–∂–Ω–µ–µ)
  const gw = game.clientWidth;
  const gh = game.clientHeight;
  let x, y;

// --- –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –ø–æ –±–æ–∫–∞–º ---
const MARGIN = 20;

if (DIR === 'down' || DIR === 'up') {
  // –ø–æ–∫–∞ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ ‚Äî —Ç–æ—á–Ω—É—é X –ø–æ–¥–æ–∂–º—ë–º –ø–æ–∑–∂–µ, —É–∂–µ –∑–Ω–∞—è —à–∏—Ä–∏–Ω—É —ç–ª–µ–º–µ–Ω—Ç–∞
  x = rnd(0, gw);
  y = (DIR === 'down') ? -160 : (gh + 160);
} else {
  // –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –±—ã–ª–æ
  y = rnd(16, gh - 140);
  x = (DIR === 'left') ? -220 : (gw + 220);
}
  el.style.left = x + 'px';
  el.style.top  = y + 'px';

  game.appendChild(el);

  // –ü–æ–¥–≥–æ–Ω—è–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –ø–æ–¥ –∫–æ–Ω—Ç–µ–Ω—Ç + –≤–æ–∑–¥—É—Ö
  fitGeometryBox(el);

  // –ê–≤—Ç–æ—Ñ–∏—Ç —Ç–µ–∫—Å—Ç–∞
  autoFitText(el, FONT_SIZE, 12);

  // –ï—Å–ª–∏ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∂–∏–º ‚Äî –ø–µ—Ä–µ—Ç–∞–π–ø—Å–µ—Ç–∏—Ç—å –∏ –µ—â—ë —Ä–∞–∑ –ø–æ–¥—Ä–æ–≤–Ω—è—Ç—å
 if ((cfg.language||'') === 'math'){
  MathJax.typesetPromise([el]).then(()=>{
    fitGeometryBox(el);  // –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
    adjustX();           // –µ—â—ë —Ä–∞–∑ –ø–æ–¥–∂–∏–º–∞–µ–º X, —É–∂–µ —Å —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —à–∏—Ä–∏–Ω–æ–π
  });
}

  // –î–≤–∏–∂–µ–Ω–∏–µ (—É—á–∏—Ç—ã–≤–∞–µ–º DIR). –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –∫–æ–ª—ã—à—É—Ç—Å—è –ø–æ X, –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ ‚Äî –ø–æ Y.
  const vel = SPEED.vel;
  const swayAmp = rnd(6, 22);
  const swayFreq = rnd(0.003, 0.008);
    // –ø–æ–¥–∂–∏–º–∞–µ–º X —Ç–∞–∫, —á—Ç–æ–±—ã —Å —É—á—ë—Ç–æ–º —à–∏—Ä–∏–Ω—ã –∏ –∫–∞—á–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –º–æ–≥ –≤—ã–ª–µ–∑—Ç–∏ –∑–∞ –∫–∞–¥—Ä
function adjustX(){
  if (!(DIR === 'down' || DIR === 'up')) return; // –¥–ª—è –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –ø–∞–¥–µ–Ω–∏—è
  const W = el.offsetWidth;              // —Ä–µ–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
  const safe = swayAmp;                   // –∑–∞–ø–∞—Å –Ω–∞ –ø–æ–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø–æ X
  const min = MARGIN + safe;
  const max = Math.max(min, gw - W - MARGIN - safe);
  x = clamp(x, min, max);
  el.style.left = x + 'px';
}

  let t = 0;
  let alive = true;
  adjustX();
  function step(){
    if(!alive) return;
    t += 1;
    if (DIR === 'down'){
      y += vel;
      const dx = Math.sin(t*swayFreq) * swayAmp;
      el.style.top = y+'px';
      el.style.transform = `translateX(${dx}px)`;
      if (y > gh + 200){
        alive = false;
        if (el.dataset.good === '1') missedCorrect++;
        el.remove(); return;
      }
    } else if (DIR === 'up'){
      y -= vel;
      const dx = Math.sin(t*swayFreq) * swayAmp;
      el.style.top = y+'px';
      el.style.transform = `translateX(${dx}px)`;
      if (y < -200){
        alive = false;
        if (el.dataset.good === '1') missedCorrect++;
        el.remove(); return;
      }
    } else if (DIR === 'left'){
      x += vel;
      const dy = Math.sin(t*swayFreq) * swayAmp;
      el.style.left = x+'px';
      el.style.transform = `translateY(${dy}px)`;
      if (x > gw + 200){
        alive = false;
        if (el.dataset.good === '1') missedCorrect++;
        el.remove(); return;
      }
    } else { // right
      x -= vel;
      const dy = Math.sin(t*swayFreq) * swayAmp;
      el.style.left = x+'px';
      el.style.transform = `translateY(${dy}px)`;
      if (x < -200){
        alive = false;
        if (el.dataset.good === '1') missedCorrect++;
        el.remove(); return;
      }
    }
    requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
  // üëá –µ–¥–∏–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —ç–ª–µ–º–µ–Ω—Ç—É (–≤–Ω—É—Ç—Ä–∏ drop, –Ω–æ –≤–Ω–µ step)
  el.addEventListener('click', (ev)=>{
    if (!running) return;
    if (!alive) return;
    ev.stopPropagation();
    const isGood = el.dataset.good === '1';
    if (isGood){
      alive = false;
      hits++;
      streak++;
      const bonus = Math.max(0, streak-1) * 2;
      const pts = SPEED.basePts + bonus;
      score += pts;
      hudScore.textContent = String(score);
      foundCorrect.add(el.dataset.value);
      el.classList.add('caught');
      playPop(el);
      popScore(el, '+'+pts);
      setTimeout(()=> el.remove(), 420);
      if (foundCorrect.size >= neededCorrect){
        stopSpawning();
        clearItems();
        const totalLevels = (cfg.levels || []).length;
        if (currentLevel >= totalLevels){
          fireworks();
          try{ winSound.currentTime=0; winSound.play(); }catch(_){}
          showGameCompleteOverlay({
            score,
            hits,
            wrong: wrongClicks,
            missed: missedCorrect
          });
        } else {
          showLevelCompleteOverlay(currentLevel, totalLevels, startLevel);
        }
      }
    } else {
      wrongClicks++;
      streak = 0;
      try{ wrongSound.currentTime=0; wrongSound.play(); }catch(_){}
      el.classList.add('tint-red');
      setTimeout(()=> el.classList.remove('tint-red'), 400);
    }
  });
} // ‚Üê –∫–æ–Ω–µ—Ü —Ñ—É–Ω–∫—Ü–∏–∏ drop

/* ===================== –ì–µ–æ–º–µ—Ç—Ä–∏—è/–∞–≤—Ç–æ—Ñ–∏—Ç ===================== */
      /* ===================== –ì–µ–æ–º–µ—Ç—Ä–∏—è/–∞–≤—Ç–æ—Ñ–∏—Ç ===================== */
  function fitGeometryBox(el){
  const STYLE = cfg.style || {};
  const content = el.querySelector('.content');

  // –µ—Å–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∑–∞–¥–∞–Ω–∞ —Ñ–∏–∫—Å-—à–∏—Ä–∏–Ω–∞ —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é ‚Äî —ç—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞,
  // —Ä–∞–∑–º–µ—Ä—ã —É–∂–µ –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã –≤ drop(), –≤—ã—Ö–æ–¥–∏–º
  if (content && content.style.getPropertyValue('--cw')) return;

  const shape = STYLE.shape || 'rounded';


      // –°–±—Ä–æ—Å–∏–º, —á—Ç–æ–±—ã –∏–∑–º–µ—Ä–∏—Ç—å ¬´–Ω–∞—Ç—É—Ä–∞–ª—å–Ω—ã–π¬ª —Ä–∞–∑–º–µ—Ä
      el.style.width = ''; el.style.height='';

      const r = content.getBoundingClientRect();

      // –í–æ–∑–¥—É—Ö –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –µ—Å—Ç—å –ª–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞-—Ä–∞–º–∫–∞
 const hasImageFrame =
  (Array.isArray(STYLE.bgImage) ? STYLE.bgImage.length > 0 : !!String(STYLE.bgImage||'').trim()) ||
  (Array.isArray(STYLE.bgImages) ? STYLE.bgImages.length > 0 : false);

      const padX = hasImageFrame ? 30 : 22;
      const padY = hasImageFrame ? 24 : 18;

      let W = Math.ceil(r.width + padX*2);
      let H = Math.ceil(r.height + padY*2);

      // –ö—Ä—É–≥/—Ä–æ–º–±/–∑–≤–µ–∑–¥–∞ ‚Äî –¥–µ–ª–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –±–æ–∫—Å, —á—Ç–æ–±—ã —Ñ–æ—Ä–º–∞ –±—ã–ª–∞ ¬´–≥–µ–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∞—è¬ª, –Ω–µ –ø—Ä–∏–ø–ª—é—Å–Ω—É—Ç–∞—è
      if (shape === 'circle' || shape === 'diamond' || shape === 'star'){
        const S = Math.max(W, H);
        W = H = Math.ceil(S + 16); // —á—É—Ç—å –≤–æ–∑–¥—É—Ö–∞ —Å–≤–µ—Ä—Ö—É
      }

      el.style.width = W + 'px';
      el.style.height = H + 'px';
    }

    function autoFitText(el, startPx, minPx){
      const span = el.querySelector('.content span');
      if(!span) return;
    let fs = startPx;
      const STYLE = cfg.style || {};
      const pad = STYLE.pad ?? 18;
      const maxW = el.clientWidth - pad*2;
      const maxH = el.clientHeight - pad*2;
      const fits = ()=> {
        const rr = span.getBoundingClientRect();
        return (rr.width <= maxW && rr.height <= maxH);
      };

      while (fs > minPx){
        span.style.fontSize = fs + 'px';
        if (fits()) break;
        fs -= 1;
      }
    }

    /* ===================== –≠—Ñ—Ñ–µ–∫—Ç—ã / –æ—á–∫–∏ / —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫ ===================== */
    function playPop(el){
      try{ popSound.currentTime = 0; popSound.play(); }catch(_){}
      const r = el.getBoundingClientRect();
      for(let i=0;i<14;i++){
        const s = document.createElement('div');
        s.className = 'sparkle';
        s.style.left = (r.left + r.width/2) + 'px';
        s.style.top  = (r.top  + r.height/2) + 'px';
        const angle = Math.random() * Math.PI * 2;
        const dist = 40 + Math.random()*70;
        s.style.setProperty('--dx', (Math.cos(angle)*dist) + 'px');
        s.style.setProperty('--dy', (Math.sin(angle)*dist) + 'px');
        s.style.animationDuration = (0.9 / (SPEED.basePts/12)) + 's';
        document.body.appendChild(s);
        setTimeout(()=> s.remove(), 1000);
      }
    }

    function popScore(el, text){
      const r = el.getBoundingClientRect();
      const node = document.createElement('div');
      node.className = 'score-float';
      node.style.left = (r.left + r.width/2) + 'px';
      node.style.top  = (r.top + 8) + 'px';
      node.style.color = 'var(--ui)';
      node.textContent = text;
      document.body.appendChild(node);
      setTimeout(()=> node.remove(), 900);
    }

    function fireworks(count=16){
      const W = window.innerWidth, H = window.innerHeight;
      for(let k=0;k<count;k++){
        const x = Math.random()*W*0.8 + W*0.1;
        const y = Math.random()*H*0.5 + H*0.1;
        const parts = 24;
        for(let i=0;i<parts;i++){
          const p = document.createElement('div');
          p.className='firework';
          p.style.left = x+'px'; p.style.top = y+'px';
          const angle = (Math.PI*2) * (i/parts) + Math.random()*0.2;
          const dist = 60 + Math.random()*120;
          p.style.setProperty('--tx', (Math.cos(angle)*dist)+'px');
          p.style.setProperty('--ty', (Math.sin(angle)*dist)+'px');
          p.style.background = `hsl(${Math.floor(Math.random()*360)},90%,70%)`;
          document.body.appendChild(p);
          setTimeout(()=> p.remove(), 900);
        }
      }
    }
  </script>
</body>
</html>
